<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | BiblioNet</title>

    <link rel="stylesheet" th:href="@{/css/main.css}">
</head>

<body>

<div th:replace="layout/header :: header"></div>
<div th:replace="layout/sidebar :: sidebar"></div>

<main class="content">
    <div class="card">

        <h2>Bienvenue sur BiblioNet</h2>

        <p>
            ConnectÃ© en tant que :
            <strong th:text="${#authentication.authorities[0].authority}"></strong>
        </p>

        <!-- ================= SUPER ADMIN ================= -->
        <div th:if="${#authorization.expression('hasRole(''SUPER_ADMIN'')')}">
            <h3>ğŸ‘‘ Super Administrateur</h3>
            <ul>
                <li>CrÃ©er et gÃ©rer les bibliothÃ¨ques</li>
                <li>CrÃ©er et gÃ©rer les administrateurs</li>
                <li>Vision globale du rÃ©seau</li>
            </ul>
        </div>

        <!-- ================= ADMIN ================= -->
        <div th:if="${#authorization.expression('hasRole(''ADMIN'')')}">
            <h3>ğŸ›  Administrateur</h3>
            <ul>
                <li>GÃ©rer les bibliothÃ©caires</li>
                <li>Superviser sa bibliothÃ¨que</li>
            </ul>
        </div>

        <!-- ================= BIBLIOTHÃ‰CAIRE ================= -->
        <div th:if="${#authorization.expression('hasRole(''BIBLIOTHECAIRE'')')}">
            <h3>ğŸ“š BibliothÃ©caire</h3>
            <ul>
                <li>GÃ©rer les prÃªts</li>
                <li>GÃ©rer les ressources</li>
            </ul>
        </div>

        <!-- ================= LECTEUR ================= -->
        <div th:if="${#authorization.expression('hasRole(''LECTEUR'')')}">
            <h3>ğŸ™‹ Lecteur</h3>
            <ul>
                <li>Consulter ses prÃªts</li>
                <li>GÃ©rer ses rÃ©servations</li>
            </ul>
        </div>

    </div>
</main>

<div th:replace="layout/footer :: footer"></div>

<!-- ====================== SCRIPT NOTIFICATIONS ====================== -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const notifBell = document.getElementById("notifBell");
    const notifCount = document.getElementById("notifCount");
    const notifList = document.getElementById("notifList");
    const notifItems = document.getElementById("notifItems");

    if (!notifBell) return;

    notifBell.onclick = () => {
        notifList.style.display = notifList.style.display === "none" ? "block" : "none";
        notifCount.style.display = "none";
    };

    function addNotif(text) {
        const li = document.createElement("li");
        li.innerText = text;
        notifItems.prepend(li);
    }

    // Chargement initial depuis DB
    fetch("/api/notifications")
    .then(r => r.json())
    .then(list => {

        // Compteur = nombre de prÃªts non retournÃ©s ayant gÃ©nÃ©rÃ© une notification
        notifCount.innerText = list.length;
        notifCount.style.display = list.length > 0 ? "inline" : "none";

        notifItems.innerHTML = ""; // Clear

        list.forEach(n => {
            const li = document.createElement("li");
            li.innerText = n.message;
            li.style.fontWeight = "bold";
            li.style.color = "red"; // notification active
            notifItems.appendChild(li);
        });
    });

    // WebSocket live
    const socket = new SockJS('/ws');
    const stomp = Stomp.over(socket);

    stomp.connect({}, () => {
        stomp.subscribe("/user/topic/notifications", msg => {
            addNotif(msg.body);
            notifCount.style.display = "inline";
        });
    });
});
</script>

<!-- ====================== SCRIPT SIDEBAR ====================== -->
<script>
function toggleSidebar() {
    document.getElementById("sidebar").classList.toggle("hidden");
}

function toggleSubmenu(id) {
    const submenu = document.getElementById(id);
    submenu.style.display =
        submenu.style.display === "flex" ? "none" : "flex";
}
</script>

</body>
</html>
