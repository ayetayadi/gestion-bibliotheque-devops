<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>PrÃªts en cours</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <style>
        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .badge-reserve { background: #ff9800; }
        .badge-emprunte { background: #1976d2; }
        .badge-en_cours { background: #009688; }
        .badge-retourne { background: #9c27b0; }
        .badge-cloture { background: #555; }
        .btn-sm {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 13px;
        }
        input[type="date"] {
            padding: 4px;
            font-size: 12px;
            margin-right: 4px;
        }
    </style>
</head>
<body>

<div th:replace="layout/header :: header"></div>
<div th:replace="layout/sidebar :: sidebar"></div>

<main class="content">

<div id="notif-container">
    <h4>Notifications</h4>
    <ul id="notifications"></ul>
</div>

    <h2>ðŸ“š PrÃªts en cours</h2>
    <table class="table">
        <thead>
        <tr>
            <th>Ressource</th>
            <th>Lecteur</th>
            <th>Email</th>
            <th>Statut</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="pret : ${prets}">
            <td th:text="${pret.ressource.titre}"></td>
            <td th:text="${pret.lecteur.nom + ' ' + pret.lecteur.prenom}"></td>
            <td th:text="${pret.lecteur.email}"></td>
            <td>
                <span class="badge" 
                      th:classappend="' badge-' + ${pret.statut.name().toLowerCase()}"
                      th:text="${pret.statut}"></span>
            </td>
            <td>
                <!-- Validation prÃªt RESERVE : date de dÃ©but et fin -->
                <form th:if="${pret.statut.name() == 'RESERVE'}"
                      th:action="@{/bibliothecaire/prets/valider/{id}(id=${pret.id})}"
                      method="post">
                    <label>DÃ©but:</label>
                    <input type="date" name="dateDebut" required>
                    <label>Fin:</label>
                    <input type="date" name="dateFin" required>
                    <button class="btn btn-success btn-sm">Valider</button>
                </form>

                <!-- Retourner un prÃªt EMPRUNTE / EN_COURS -->
                <form th:if="${pret.statut.name() == 'EMPRUNTE' or pret.statut.name() == 'EN_COURS'}"
                      th:action="@{/bibliothecaire/prets/retourner/{id}(id=${pret.id})}"
                      method="post">
                    <button class="btn btn-warning btn-sm">Retourner</button>
                </form>

                <!-- ClÃ´turer un prÃªt RETOURNE -->
                <form th:if="${pret.statut.name() == 'RETOURNE'}"
                      th:action="@{/bibliothecaire/prets/cloturer/{id}(id=${pret.id})}"
                      method="post">
                    <button class="btn btn-primary btn-sm">ClÃ´turer</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
</main>

</body>


<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
<script>
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function(frame) {
        console.log('ConnectÃ©: ' + frame);

        stompClient.subscribe('/user/' + "${#authentication.name()}" + '/topic/notifications', function(msg) {
            const notifList = document.getElementById('notifications');
            const li = document.createElement('li');
            li.textContent = msg.body;
            notifList.prepend(li); // Ajoute en haut
        });
    });
</script>

</html>
