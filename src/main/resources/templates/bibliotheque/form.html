<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ajouter une bibliothèque | BiblioNet</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>#map { height: 350px; margin-top: 10px; border-radius: 12px; }</style>
</head>
<body>

<div th:replace="layout/header :: header"></div>
<div th:replace="layout/sidebar :: sidebar"></div>

<main class="content">
    <div class="page-header">
        <div>
            <h2>Ajouter bibliothèque</h2>
            <p class="text-muted">Création d’une nouvelle bibliothèque</p>
        </div>
    </div>

    <div class="card form-card">
        <form th:action="@{/super-admin/bibliotheques}" th:object="${bibliotheque}" method="post">

            <div class="form-grid">

                <div class="form-group">
                    <label>Nom</label>
                    <input type="text" th:field="*{nom}" required>
                </div>

                <div class="form-group">
                    <label>Code</label>
                    <input type="text" th:field="*{code}" required>
                </div>

                <div class="form-group">
                    <label>Rue</label>
                    <input type="text" th:field="*{adresse.rue}" id="rue" required>
                </div>

                <div class="form-group">
                    <label>Ville</label>
                    <input type="text" th:field="*{adresse.ville}" id="ville" required>
                </div>

                <div class="form-group">
                    <label>Code postal</label>
                    <input type="text" th:field="*{adresse.codePostal}" id="codePostal" required>
                </div>

                <div class="form-group">
                    <label>Téléphone</label>
                    <input type="text" th:field="*{telephone}" placeholder="+216 12 345 678">
                </div>

                <div class="form-group">
                    <label>Email de contact</label>
                    <input type="email" th:field="*{emailContact}" placeholder="contact@bibliotheque.tn">
                </div>

                <!-- MAP -->
                <div class="form-group" style="grid-column: span 2;">
                    <label>Localisation sur la carte</label>
                    <div id="map"></div>
                </div>

                <input type="hidden" th:field="*{adresse.latitude}" id="latitude">
                <input type="hidden" th:field="*{adresse.longitude}" id="longitude">

            </div>

            <div class="form-actions">
                <button class="btn btn-primary">Enregistrer</button>
            </div>
        </form>
    </div>
</main>

<div th:replace="layout/footer :: footer"></div>

<script th:inline="javascript">
    let lat = [[${bibliotheque.adresse.latitude != null ? bibliotheque.adresse.latitude : 36.8065}]];
    let lng = [[${bibliotheque.adresse.longitude != null ? bibliotheque.adresse.longitude : 10.1815}]];

    const map = L.map('map').setView([lat, lng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([lat, lng], {draggable:true}).addTo(map);

    function updateLatLng(lat, lng) {
        document.getElementById("latitude").value = lat;
        document.getElementById("longitude").value = lng;
    }
    updateLatLng(lat, lng);

    // Click sur la carte → reverse geocoding
    map.on('click', e => {
        const latlng = e.latlng;
        marker.setLatLng(latlng);
        updateLatLng(latlng.lat, latlng.lng);

        fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latlng.lat}&lon=${latlng.lng}`)
            .then(resp => resp.json())
            .then(data => {
                if(data.address){
                    document.getElementById("rue").value = data.address.road || '';
                    document.getElementById("ville").value = data.address.city || data.address.town || data.address.village || '';
                    document.getElementById("codePostal").value = data.address.postcode || '';
                }
            }).catch(err => console.log(err));
    });

    // Champs adresse → géocode pour marker
    function geocodeAddress() {
        const rue = document.getElementById("rue").value;
        const ville = document.getElementById("ville").value;
        const codePostal = document.getElementById("codePostal").value;
        const query = encodeURIComponent(`${rue}, ${ville}, ${codePostal}`);
        fetch(`https://nominatim.openstreetmap.org/search?format=jsonv2&q=${query}`)
            .then(resp => resp.json())
            .then(data => {
                if(data.length>0){
                    const latlng = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                    marker.setLatLng(latlng);
                    map.setView(latlng, 13);
                    updateLatLng(latlng[0], latlng[1]);
                }
            }).catch(err => console.log(err));
    }

    document.getElementById("rue").addEventListener("change", geocodeAddress);
    document.getElementById("ville").addEventListener("change", geocodeAddress);
    document.getElementById("codePostal").addEventListener("change", geocodeAddress);

</script>
</body>
</html>
