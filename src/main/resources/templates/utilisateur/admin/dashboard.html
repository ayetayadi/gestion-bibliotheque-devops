<!DOCTYPE html>
<html lang="fr"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>Dashboard Administrateur | BiblioNet</title>

    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<!-- HEADER -->
<div th:replace="layout/header :: header"></div>

<!-- SIDEBAR -->
<div th:replace="layout/sidebar :: sidebar"></div>

<main class="dashboard-content">

    <!-- ================= HEADER ================= -->
    <section class="dashboard-header">
        <div>
            <h2>
                <i class="fas fa-chart-line"></i>
                Dashboard â€“ BibliothÃ¨que
            </h2>
            <p class="subtitle">
                Vue dâ€™ensemble de lâ€™activitÃ© et du stock
            </p>
        </div>

        <a th:href="@{/admin/export/rapport/pdf}" class="btn-export">
            <i class="fas fa-file-pdf"></i>
            Export PDF
        </a>
    </section>

    <!-- ================= KPI GLOBAUX ================= -->
    <section>
        <h3 class="section-title">Indicateurs clÃ©s</h3>

        <div class="stats-summary">

            <div class="stat-card">
                <i class="fas fa-book stat-icon"></i>
                <div class="stat-info">
                    <h3 th:text="${totalPrets}">0</h3>
                    <p>Total des prÃªts</p>
                </div>
            </div>

            <div class="stat-card">
                <i class="fas fa-boxes stat-icon"></i>
                <div class="stat-info">
                    <h3 th:text="${totalStock}">0</h3>
                    <p>Stock total</p>
                </div>
            </div>

            <div class="stat-card">
                <i class="fas fa-percentage stat-icon"></i>
                <div class="stat-info">
                    <h3 th:text="${#numbers.formatDecimal(tauxRotation,1,2)} + '%'">0%</h3>
                    <p>Taux de rotation</p>
                </div>
            </div>

        </div>
    </section>

    <!-- ================= KPI STATUT ================= -->
    <section>
        <h3 class="section-title">Ã‰tat des prÃªts</h3>

        <div class="stats-summary">

            <div class="stat-card small green">
                <i class="fas fa-bookmark"></i>
                <h4 th:text="${pretsParStatut['RESERVE']} ?: 0">0</h4>
                <p>RÃ©servÃ©s</p>
            </div>

            <div class="stat-card small red">
                <i class="fas fa-book-reader"></i>
                <h4 th:text="${pretsParStatut['EMPRUNTE']} ?: 0">0</h4>
                <p>EmpruntÃ©s</p>
            </div>

            <div class="stat-card small blue">
                <i class="fas fa-undo"></i>
                <h4 th:text="${pretsParStatut['RETOURNE']} ?: 0">0</h4>
                <p>RetournÃ©s</p>
            </div>

            <div class="stat-card small orange">
                <i class="fas fa-check-circle"></i>
                <h4 th:text="${pretsParStatut['CLOTURE']} ?: 0">0</h4>
                <p>ClÃ´turÃ©s</p>
            </div>

        </div>
    </section>

    <!-- ================= ANALYSES ================= -->
    <section class="analytics-section">
        <h3 class="section-title">
            <i class="fas fa-chart-bar"></i>
            Analyses statistiques
        </h3>

        <div class="charts-container">

            <!-- Par catÃ©gorie -->
            <div class="chart-wrapper">
                <div class="chart-header">
                    <h4>ðŸ“š PrÃªts par catÃ©gorie</h4>
                </div>
                <div class="chart-box">
                    <canvas id="categorieChart"></canvas>
                </div>
            </div>

            <!-- Par statut -->
            <div class="chart-wrapper">
                <div class="chart-header">
                    <h4>ðŸ“Œ RÃ©partition par statut</h4>
                </div>
                <div class="chart-box">
                    <canvas id="statutChart"></canvas>
                </div>
            </div>

        </div>
    </section>

</main>

<!-- ================= JS ================= -->
<script th:inline="javascript">
    const pretsParCategorie = /*[[${pretsParCategorie}]]*/ {};
    const pretsParStatut = /*[[${pretsParStatut}]]*/ {};

    new Chart(document.getElementById('categorieChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(pretsParCategorie),
            datasets: [{
                label: 'Nombre de prÃªts',
                data: Object.values(pretsParCategorie),
                backgroundColor: '#3A57E8'
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    const values = Object.values(pretsParStatut);
    const total = values.reduce((a, b) => a + b, 0);

    new Chart(document.getElementById('statutChart'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(pretsParStatut),
            datasets: [{
                data: values,
                backgroundColor: ['#10B981','#EF4444','#3B82F6','#F59E0B']
            }]
        },
        options: {
            cutout: '65%',
            plugins: {
                tooltip: {
                    callbacks: {
                        label: ctx => {
                            const pct = total ? ((ctx.raw / total) * 100).toFixed(1) : 0;
                            return `${ctx.label} : ${ctx.raw} (${pct}%)`;
                        }
                    }
                },
                legend: { position: 'bottom' }
            }
        }
    });
</script>

</body>
</html>
